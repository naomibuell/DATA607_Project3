---
title: "Project3"
author: "Nicholas Kunze, Naomi Buell, Kaylie Evans"
date: "2024-03-15"
output:
  html_document:
    highlight: pygments
    theme: cerulean
    toc: true
    toc_float: true
  pdf_document: default
editor_options: 
  chunk_output_type: inline
params:
  dbuser: 
    label: "Username"
    value: "nicholas.kunze77"
    input: text
  dbpass: 
    label: "Password"
    value: "nicholas.kunze77"
    input: password
  dbname: 
    label: "Database"
    value: "nicholas.kunze77"
    input: password
  dbhost: 
    label: "Host"
    value: "cunydata607sql.mysql.database.azure.com"
    input: password
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if("tidyverse" %in% rownames(installed.packages()) == FALSE) {install.packages("tidyverse")}
if("RMySQL" %in% rownames(installed.packages()) == FALSE) {install.packages("RMySQL")}
library(RMySQL)
library(tidyverse)
```

## Load Database

Get normalized database from MySQL server and browse.

```{r getdb}
azuredb = dbConnect(MySQL(), user=params$dbuser, password=params$dbpass, dbname=params$dbname, host=params$dbhost)

jobs <- dbGetQuery(azuredb, 
  "SELECT 
      j.id as id, t.title as title, c.cname as company, o.val as onsite_remote, 
    	j.descr as `description`, j.salary as salary, j.location as location, j.criteria as criteria, 
    	j.posted as posted, j.link as link
   FROM 
      jobs j, job_title t, company c, onsite_remote o
   WHERE 
      j.title = t.id AND j.cid = c.id AND j.orid = o.id;")
head(jobs)
```

## Tidy Description

Prepare to find skills as listed in `skills_list_str` in the `description` variable.

```{r clean-desc-gen}
skills_list_str <- 'python,r,sql,machine learning,data mining,data visualization,big data,sql,nosql,hadoop,spark,statistics,a/b,cleaning,data warehouse,etl,data lake,communication,teamwork,sklearn,scikit,pandas,numpy,tensorflow,keras,pytorch,database,mysql,postgresql,oracle,mongo,cloud,aws,azure,google cloud,git,deep learning,dnn,neural network,powerbi,tableau,teradata,javascript,airflow,linux,perl,java,php,bachelor,master,phd,doctorate'
skills_list <- strsplit(skills_list_str,split=",",fixed=TRUE)[[1]]
jobs[, 'skills'] = ""
```

Iterate over job descriptions and check for skill.

```{r clean-desc-skills}
for (row in 1:nrow(jobs)) {
  job <- jobs[row,]
  desc <- tolower(job$description)
  for(skill in skills_list) {
    if(grepl(skill, desc, fixed = TRUE)) {
      jobs[row,]$skills <- paste(jobs[row,]$skills,skill,",")
    }
  }
}
```

Create normalized table of skills mapped to unique job ID in `jobs` data frame.

```{r clean-skills}
jobs.skills <- jobs %>%
  pivot_longer(skills) %>%
  mutate(value = strsplit(as.character(value), ",")) %>%
  unnest(value) %>%
  group_by(id, value) %>%
  summarize(value = unique(value), .groups = "drop") %>%
  as.data.frame()
head(jobs.skills)
```

## Tidy Criteria

Split up `criteria` variable to create separate variables for seniority, employment type, job function, and industry.

```{r clean-criteria}
jobs <- jobs %>%
    mutate(seniority = str_extract(criteria, "(?<='Seniority level': ')(.*?)(?='\\})"))
jobs <- jobs %>%
    mutate(etype = str_extract(criteria, "(?<='Employment type': ')(.*?)(?='\\})"))
jobs <- jobs %>%
    mutate(jfunction = str_extract(criteria, "(?<='Job function': ')(.*?)(?='\\})"))
jobs <- jobs %>%
    mutate(industries = str_extract(criteria, "(?<='Industries': ')(.*?)(?='\\})"))
```

Normalized table of industries mapped to unique job ID in `jobs` data frame.

```{r industries}
jobs.industries <- jobs %>%
  pivot_longer(industries) %>%
  mutate(value = strsplit(as.character(value), ",")) %>%
  unnest(value) %>%
  group_by(id, value) %>%
  summarize(value = unique(value), .groups = "drop") %>%
  as.data.frame()
jobs.industries <- jobs.industries %>%
  mutate(across('value', ~str_remove_all(., 'and ')))
```

## Tidy Title

List of unique raw titles below. All are data analysts. Some job titles have other information included in the field (e.g., remote/hybrid information).

```{r title-factors}
unique(jobs$title)
```

To be tidy, every cell can only have one piece of information. To this end, pull out remote/hybrid details from "title". As a check, we verify that this info matches with the existing "onsite_remote" column.

```{r title}
jobs <- jobs |>
  # pull extra detail from "tite" to variable "analyst_detail"
  mutate(
    analyst_detail = title |>
      str_remove("Data Analyst") |>
      str_remove("Data analyst") |>
      str_remove(" - ") |>
      str_trim(),
    # pull details into new column for onsite_remote for QC
    analyst_detail_onsite_remote = str_detect(analyst_detail, "Remote") |
      str_detect(analyst_detail, "remote") |
      str_detect(analyst_detail, "Hybrid") |
      str_detect(analyst_detail, "REMOTE") |
      str_detect(analyst_detail, "WFH") |
      str_detect(analyst_detail, "Onsite"),
    # Remove these details and more from our list of details using REGEX
    title_clean = title |>
      str_replace("analyst", "Analyst") |> # standardize capitalization
      str_remove("Remote") |> # remove remote/onsite qualifiers
      str_remove("remote") |>
      str_remove("Hybrid") |>
      str_remove("REMOTE") |>
      str_remove("WFH") |> 
      str_remove("Onsite")|>
      str_remove("Weekly.*Schedule") |> 
      str_remove("\\(.*\\)") |> # remove parentheticals
      str_remove("\\/.*\\/") |> # remove content within slashes
      str_remove("//") |> # remove other symbols to standardize
      str_remove("!") |>
      str_remove("- $") |> 
      str_replace("  "," ") |> 
      str_trim() |> 
      as.factor()
  )
```

Here are all the values in my cleaned titles column:

```{r titles-clean}
levels(jobs$title_clean)
```

As a check, I browsed the data to verify that remote/onsite job title qualifiers matched with specifications in the `remote_onsite` column. Everything looks consistent:

```{r verify-onsite-remote}
jobs_onsite_check <- jobs |> 
  filter(analyst_detail_onsite_remote) |> 
  select(title, onsite_remote) |> 
  unique()

head(jobs_onsite_check, nrow(jobs_onsite_check))
```

## Clean Location

Next we work with location, which contains data with varying levels of granularity (e.g., some at state level, some at city level). We make columns consistent by separating data into state and location columns. We split `location` column into two separate columnsâ€“one for city and one for state below:

```{r split-location}
jobs <- jobs |>
  mutate(
    location_1 = str_extract(location, "[^,]+"),
    # get location before the comma, typically city
    location_2 = str_extract(location, "(?<=,\\s).+") # use REGEX to get location after the comma, typically state
  )
```

We use the built in R data set to ensure the `state` variable is consistent; we use state abbreviations throughout. I also manually fix one city-state combination (Columbus, South Carolina Metropolitan Area to Columbus, SC).

```{r revise-locations}
# get state names and abbreviations from built-in dataset
states <- data.frame(state.abb, state.name) |>
  rename(location_1 = state.name)

jobs <- jobs |>
  left_join(states) |> # join to get state abbrevs
  mutate(
    # gen state (abbreviation) variable
    state = if_else(location_2 == "United States", state.abb, location_2) |>
      as.factor(),
    
    city = if_else(is.na(state.abb) |
                     location_2 != "United States", location_1, NA) |>
      as.factor()
  ) |>
  # fix South Carolina Metropolitan Area incorrect state
  mutate(state = if_else(state == "South Carolina Metropolitan Area", "SC", state) |>
           as.factor())
```

Here are the unique cities and states in which jobs were posted:

```{r summ-cities}
levels(jobs$city)
```

And here are the unique states:

```{r summ-states}
levels(jobs$state)
```

## Check Company

Browsing companies for opportunities for standardization. It appears that this column is OK as is.

```{r browse-companies}
head(jobs |> select(company) |> unique())
```

## Clean Onsite/Remote

Browsing `onsite_remote` column for opportunities for standardization. The values are OK and converted to a factor variable.

```{r onsite-remote}
jobs <- jobs  |>
  mutate(onsite_remote = as.factor(onsite_remote))

levels(jobs$onsite_remote)
```
